---
title: "Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{main}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library("aof")
library("bcpa")
```

A single changepoint in a time-series where the parameters change at some unknown timepoints t* is done by simply sweeping all possible breaks, and finding the most-likely changepoint according to the likelihood.

```{r cc010}
# mu1 and mu2: behavioral change: 25 or 50 (change on mu1)
# rho1 and rho2 : intrerval frequency
# n.obs: number of observations from 5 to 45
# sigma1 and sigma2: variance from 0.1 to 3
getTimeBudget <- function(
  mu1 = 50,
  mu2 = 50,
  rho1 = 0.5,
  rho2 = 0.5,
  n.obs = 5, 
  sigma1 = 3,
  sigma2 = 3,
  t.full = 0:50,
  t.break = 25
){
  SimTS <- function(n, mu, rho, sigma){
    X.standard <- arima.sim(n, model = list(ar = rho))
    X.standard/sd(X.standard)*sigma + mu
  }
  x.full <- c(SimTS(t.break, mu1, rho1, sigma1),
    SimTS(max(t.full) - t.break + 1, mu2, rho2, sigma2))
  keep <- sort(sample(1:length(x.full), n.obs))
  TimeBudget <- data.frame(
    name = "A",
    Age = t.full[keep],
    x = x.full[keep])
  return(TimeBudget)
}
getAofPlot <- function(
  TimeBudget = TimeBudget, 
  AOF = AOF, 
  t.break = 25, 
  poly = FALSE
){
  par(mar = c(4, 4, 1, 1), mfrow = c(1, 1))
  plot(
    x = TimeBudget$Age,
    y = TimeBudget$x, 
    las = 1,
    xlab = "Age (day)", ylab = "Time-activity budget",
    pch = 21,
    col = "gray20", bg = "gray80")
  goodbreak1 = max(TimeBudget$Age[TimeBudget$Age < t.break])
  goodbreak2 = min(TimeBudget$Age[TimeBudget$Age >= t.break])
  if(poly == TRUE){
    polygon(
      c(
        goodbreak1 - 0.5, 
        goodbreak2 + 0.5, 
        goodbreak2 + 0.5, 
        goodbreak1 - 0.5),
      c(0, 0, 100, 100), 
      col = "gray50", border = NA)
  }
  abline(v = AOF$AOF, col = "black", lwd = 2, lty = 3)
  lines(
    x = c(min(TimeBudget$Age), AOF$AOF), 
    y = c(AOF$behav.learning, AOF$behav.learning), 
    col = "black", lwd = 2)
  lines(
    x = c(AOF$AOF, max(TimeBudget$Age)),
    y = c(AOF$behav.foraging, AOF$behav.foraging),
    col = "black", lwd = 2)
  return(c(goodbreak1, goodbreak2))
}
```

# 1. Examples with no change simulated in the time series

## 1.1. Low number of individuals and low variance

```{r cc011}
TimeBudget <- getTimeBudget(
  n.obs = 5, 
  sigma1 = 0.1,
  sigma2 = 0.1)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc011b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF)
```

## 1.2. Low number of individuals and high variance

```{r cc012}
TimeBudget <- getTimeBudget(
  n.obs = 5, 
  sigma1 = 3,
  sigma2 = 3)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc012b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF)
```

## 1.3. High number of individuals and low variance

```{r cc013}
TimeBudget <- getTimeBudget(
  n.obs = 45, 
  sigma1 = 0.1,
  sigma2 = 0.1)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc013b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF)
```

## 1.4. High number of individuals and high variance

```{r cc014}
TimeBudget <- getTimeBudget(
  n.obs = 45, 
  sigma1 = 3,
  sigma2 = 3)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc014b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF)
```

# 2. Examples with change simulated in the time series

## 2.1. Low number of individuals and low variance

```{r cc021}
TimeBudget <- getTimeBudget(
  mu1 = 25,
  n.obs = 5, 
  sigma1 = 0.1,
  sigma2 = 0.1)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc021b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF, poly = TRUE)
```

## 2.2. Low number of individuals and high variance

```{r cc022}
TimeBudget <- getTimeBudget(
  mu1 = 25,
  n.obs = 5, 
  sigma1 = 3,
  sigma2 = 3)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc022b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF, poly = TRUE)
```

## 2.3. High number of individuals and low variance

```{r cc023}
TimeBudget <- getTimeBudget(
  mu1 = 25,
  n.obs = 45, 
  sigma1 = 0.1,
  sigma2 = 0.1)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc023b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF, poly = TRUE)
```

## 2.3. High number of individuals and high variance

```{r cc024}
TimeBudget <- getTimeBudget(
  mu1 = 25,
  n.obs = 45, 
  sigma1 = 3,
  sigma2 = 3)
print(TimeBudget)
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[,3])
print(AOF)
```

```{r cc024b, fig.width=7, fig.height=5, warning=FALSE}
getAofPlot(TimeBudget, AOF, poly = TRUE)
```

# 3. Real dataset

This is a subset of 16 bees randomly selected in the exeprimental design of Requier et al. (J. Animal Ecology). 

```{r cc030, warning=FALSE}
TimeBudget <- dataExample
head(TimeBudget, n = 25)
# working on Number of trips
varX <- "Number"
```

```{r cc031, warning=FALSE}
AOF <- aof(
  name = TimeBudget[,1], 
  Age = TimeBudget[,2], 
  x = TimeBudget[varX])
print(AOF)
```

```{r cc032, fig.width=7, fig.height=5, warning=FALSE}
goodbreak <- lapply(seq_along(unique(TimeBudget[,1])), function(i){
  print(as.character(unique(TimeBudget[,1])[i]))
  TimeBx <- TimeBudget[TimeBudget[,1] == unique(TimeBudget[,1])[i], c("name", "Age", varX)]
  names(TimeBx)[3] <- "x"
  getAofPlot(
    TimeBudget = TimeBx, 
    AOF = AOF[i, ],
    poly = TRUE)
})
```








